<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>subscription.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<header class="page-header" style="height: 60px">
    <div
        class="page-header-content"
        style="align-items: center; display: flex; height: 60px; position: fixed;"
    >
        <a class="page-logo-link" href="https://www.satori.com" style="cursor: pointer;">
            <img
                alt="Satori"
                class="page-logo-image"
                height="30"
                src="https://www.satori.com/assets/images/logo-light@2x.png"
                width="177"
            />
        </a>
    </div>
</header>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Observer.html">Observer</a><ul class='methods'><li data-type='method'><a href="Observer.html#fire">fire</a></li><li data-type='method'><a href="Observer.html#off">off</a></li><li data-type='method'><a href="Observer.html#on">on</a></li></ul></li><li><a href="RTM.html">RTM</a><ul class='methods'><li data-type='method'><a href="RTM.html#.roleSecretAuthProvider">roleSecretAuthProvider</a></li><li data-type='method'><a href="RTM.html#delete">delete</a></li><li data-type='method'><a href="RTM.html#fire">fire</a></li><li data-type='method'><a href="RTM.html#getSubscription">getSubscription</a></li><li data-type='method'><a href="RTM.html#isConnected">isConnected</a></li><li data-type='method'><a href="RTM.html#isStopped">isStopped</a></li><li data-type='method'><a href="RTM.html#off">off</a></li><li data-type='method'><a href="RTM.html#on">on</a></li><li data-type='method'><a href="RTM.html#publish">publish</a></li><li data-type='method'><a href="RTM.html#read1">read</a></li><li data-type='method'><a href="RTM.html#read2">read</a></li><li data-type='method'><a href="RTM.html#restart">restart</a></li><li data-type='method'><a href="RTM.html#resubscribe">resubscribe</a></li><li data-type='method'><a href="RTM.html#search">search</a></li><li data-type='method'><a href="RTM.html#start">start</a></li><li data-type='method'><a href="RTM.html#stop">stop</a></li><li data-type='method'><a href="RTM.html#subscribe">subscribe</a></li><li data-type='method'><a href="RTM.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="RTM.html#write">write</a></li></ul></li><li><a href="Subscription.html">Subscription</a><ul class='methods'><li data-type='method'><a href="Subscription.html#fire">fire</a></li><li data-type='method'><a href="Subscription.html#off">off</a></li><li data-type='method'><a href="Subscription.html#on">on</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="RTM.SubscriptionMode.html">SubscriptionMode</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">subscription.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Observer = require('./observer.js');
var objectAssign = require('object-assign');

/**
 * Create a subscription instance.
 * @class
 * @augments Observer
 *
 * @description
 * The &lt;code>Subscription&lt;/code> class manages the state and events of a
 * subscription.
 *
 * You can use the &lt;code>Subscription&lt;/code> class to define application functionality
 * when specific events occur, like receiving a message, or when the subscription
 * enters different subscription state machine state.
 *
 * When the application receives a message as subscription data, the &lt;code>data&lt;/code>
 * event occurs and the received message is passed, as a Protocol Data Unit (PDU),
 * to the &lt;code>fn&lt;/code> parameter of the
 * [Subscription.on(event, fn)]{@link Subscription#on} event handler method.
 *
 * Use the [Subscription.on(event, fn)]{@link Subscription#on} method to add an
 * event handler to the subscription, which 'fires' when the subscription
 * receives a published message. The event parameter in this method can take a
 * value of &lt;code>data&lt;/code> or the value of the action element of the PDU,
 * for example, &lt;code>rtm/subscription/data&lt;/code>.
 *
 * You can also set event handlers when the subscription enters or leaves
 * a state in the subscription state machine. A subscription can be in
 * one of the following states: &lt;code>subscribing&lt;/code>, &lt;code>subscribed&lt;/code>,
 * &lt;code>unsubscribing&lt;/code>, &lt;code>unsubscribed&lt;/code>, or &lt;code>failed&lt;/code>.
 *
 * See
 * &lt;strong>State Machines&lt;/strong> in the online docs.
 *
 * &lt;strong>Note:&lt;/strong> When the connection from the RTM client to
 * RTM drops, all subscriptions are unsubscribed, and then resubscribed
 * when the connection is restored. You can direct the JavaScript SDK to automatically
 * reconnect or you can detect the disconnect manually and then reconnect to
 * RTM at the proper message stream position with the
 * &lt;code>position&lt;/code> parameter.
 *
 * @example
 * // create a new subscription to the 'your-channel' channel
 * var subscription = rtm.subscribe('your-channel');
 *
 *
 * subscription.on('rtm/subscription/data', function (pdu) {
 *     pdu.body.messages.forEach(console.log);
 * });
 * subscription.on('enter-subscribed', function () {
 *     rtm.publish('your-channel', {type: 'init'});
 * });
 * subscription.on('data', function (pdu) {
 *     if (pdu.action.endWith('/error')) {
 *         rtm.restart();
 *     }
 * });
 *
 * @param {string} subscriptionId - String that identifies the channel. If you do not
 * use the &lt;code>filter&lt;/code> parameter, it is the channel name. Otherwise,
 * it is a unique identifier for the channel (subscription id).
 *
 * @param {Object} opts - Additional subscription options.
 *
 * @param {boolean} [opts.mode]
 * Sets subscription mode. Can be &lt;code>SIMPLE&lt;/code>, &lt;code>RELIABLE&lt;/code>, or
 * &lt;code>ADVANCED&lt;/code>.
 *
 * @param {object} [opts.bodyOpts={}]
 * Additional subscription options for a channel subscription. These options
 * are sent to RTM in the &lt;code>body&lt;/code> element of the PDU that represents the subscribe
 * request.
 *
 * For more information about the &lt;code>body&lt;/code> element of a PDU,
 * see &lt;em>RTM API&lt;/em> in the online docs.
 *
 * @throws {TypeError} &lt;code>TypeError&lt;/code> indicates that mandatory
 * parameters are missing or invalid.
 *
 */
function Subscription(subscriptionId, _opts) {
  if (typeof subscriptionId !== 'string') {
    throw new TypeError('"subscriptionId" is missing or invalid');
  }
  Observer.call(this);

  this.options = objectAssign({}, _opts);
  if (typeof this.options.bodyOpts !== 'object') {
    this.options.bodyOpts = {};
  }
  if (this.options.fastForward) {
    this.options.bodyOpts.fast_forward = true;
  }

  this.position = null;
  this.subscriptionId = subscriptionId;
  this.wasSubscribedAtLeastOnce = false;
  this.isSubscribed = false;
  /* eslint-enable camelcase */
}

Subscription.prototype = Object.create(Observer.prototype);

Subscription.prototype.subscribePdu = function (id) {
  var body;

  // inherit all users options like 'filter', 'fast_forward'
  if (this.options.bodyOpts.filter) {
    body = { subscription_id: this.subscriptionId };
  } else {
    body = { channel: this.subscriptionId };
  }

  body = objectAssign(body, this.options.bodyOpts);

  if (this.wasSubscribedAtLeastOnce) {
    if (this.position !== null) {
      body.position = this.position;
    } else {
      delete body.position;
    }
  }
  return {
    id: id,
    action: 'rtm/subscribe',
    body: body,
  };
};

Subscription.prototype.unsubscribePdu = function (id) {
  return {
    id: id,
    action: 'rtm/unsubscribe',
    body: { subscription_id: this.subscriptionId },
  };
};

Subscription.prototype.onPdu = function (pdu) {
  var body = pdu.body;
  if (body &amp;&amp; body.position) {
    this._onPosition(body.position);
  }
  if (pdu.action === 'rtm/subscribe/ok') {
    this.isSubscribed = true;
    this.wasSubscribedAtLeastOnce = true;
    this.fire('enter-subscribed');
  }
  if (pdu.action === 'rtm/unsubscribe/ok') {
    this._markAsUnsubscribed();
  }
  if (pdu.action === 'rtm/subscription/error') {
    this._markAsUnsubscribed();
  }
  this.fire('data', pdu, this);
  this.fire(pdu.action, pdu, this);
};

Subscription.prototype.onDisconnect = function () {
  this._markAsUnsubscribed();
};

Subscription.prototype._onPosition = function (position) {
  if (this.options.trackPosition) {
    this.position = position;
  }
  this.fire('position', position, this);
};

Subscription.prototype._markAsUnsubscribed = function () {
  if (this.isSubscribed) {
    this.isSubscribed = false;
    this.fire('leave-subscribed');
  }
};

module.exports = Subscription;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sat Apr 01 2017 21:02:19 GMT+0200 (CEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
